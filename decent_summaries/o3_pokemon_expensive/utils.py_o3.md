File utils.py Summarized: 

The module serves as a Python compatibility layer that smooths over the differences among Anthropic Claude, Google Gemini, and OpenAI’s chat or tool-calling interfaces so that a single agent can swap language-model back-ends without altering higher-level code. It includes several translator functions.

The first, convert_anthropic_message_history_to_google_format, walks through a history of messages written for Anthropic. While doing so it renames the role value “assistant” to “model” and constructs a list of google.genai.types.Content objects. For every message it creates the appropriate google.genai.types.Part, handling plain text, images, tool calls identified under the key “tool_use,” and tool results under “tool_result.” To accommodate Gemini’s ordering requirements it remembers the most recent tool and image parts so they can be appended in the correct sequence.

The second utility, extract_tool_calls_from_gemini, analyzes a google.genai.types.GenerateContentResponse and separates free-form text from structured calls to functions or tools. It also includes a fallback routine that, when Gemini embeds a tool call inside a fenced Python code block instead of the expected JSON structure, heuristically pulls out the function name and arguments; such recoveries are marked as malformed. The function ultimately returns four items: the concatenated text for the assistant’s reply, a list of google.genai.types.FunctionCall objects, a reconstruction of the same content in Anthropic’s assistant-message style, and a Boolean indicating whether the response was malformed.

Two additional helpers convert internal tool specifications into provider-specific declarations. convert_tool_defs_to_google_format performs a shallow copy of each internal tool description, renames the “input_schema” field to “parameters,” wraps the result in google.genai.types.Tool, and returns the resulting list. convert_tool_defs_to_openai_format performs a deep copy, applies the same “input_schema” to “parameters” rename, adds a required string property named “explanation_of_action,” sets the “type” field to “function,” and produces a list that can be sent directly to the OpenAI Chat Completions endpoint.

The implementation relies only on the standard library’s copy module and typing.Any. Inline comments throughout the code document specific quirks of Gemini’s tool-calling behavior—such as the need to append the last referenced image Part—to explain the work-arounds each function employs.